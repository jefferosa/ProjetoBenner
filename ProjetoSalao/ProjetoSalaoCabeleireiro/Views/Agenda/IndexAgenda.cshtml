@{
    Layout = "~/Views/Shared/_LayoutCliente.cshtml";
}
@using ProjetoBenner.Models;
@model IEnumerable<ProjetoBenner.Models.HorarioAtendimento>

<!-- Breadcrumb Area Start -->
<section class="breadcrumb-area section-padding-80">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="breadcrumb-content">
                    <h2>Agendar Horario</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a class="link-inicio" href="~/Home/IndexHomeCliente"><i class="icon_house_alt"></i> Inicio</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Agenda</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Area End -->
<!-- Booking Area Start -->
<section class="booking-area-start section-padding-80-0">
    <div class="container">
        <div class="row align-items-center">
            <!-- Booking Table -->
            <div class="col-8 col-lg-10">
                <div id="agenda" class="booking-table-slider owl-carousel mb-100">

                    <!-- Single Booking Table -->

                    @for (var j = 0; j < 7; j += 3)
                    {
                        DateTime data = DateTime.Today;
                        //data = data.AddDays(1);
                        var id = j;
                        string[] diasSemana = { "Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sabado" };
                        <div class="single-booking-table d-flex">
                            <!-- Single Date & Hours -->
                            <div class="single-date-hours active">
                                <div class="booking-day">
                                    <h6>@(diasSemana[((int)data.AddDays(j).DayOfWeek)]) </h6>
                                    <h6 id="@id">@(data.AddDays(j).ToShortDateString())</h6>
                                </div>
                                <div class="booking-hours d-flex flex-wrap">
                                    @foreach (var horario in Model)
                                    {
                                        var tempoTrabalho = (horario.HorarioFechamento.Hour - horario.HorarioAbertura.Hour) * 60;
                                        DateTime horarioAtendimento = horario.HorarioAbertura;
                                        for (var i = 0; i < tempoTrabalho; i += 30)
                                        {
                                            //foreach (var horarioA in ViewBag.Agenda)
                                            //{
                                            //    if (horarioA.Horario != null)
                                            //    {
                                            <span id="horaDia" class="pegaHora" data-toggle="modal" data-target="#produtoModal" data-dia="@(data.AddDays(j).ToShortDateString())">@(horarioAtendimento.ToShortTimeString())</span>
                                            horarioAtendimento = horario.HorarioAbertura.AddMinutes(30 + i);
                                            @*}
                                                }*@
                                        }
                                    }
                                </div>
                            </div>

                            <div class="single-date-hours">
                                <div class="booking-day">
                                    <h6>@(diasSemana[((int)data.AddDays(j + 1).DayOfWeek)]) </h6>
                                    <h6 id="@id">@(data.AddDays(j + 1).ToShortDateString())</h6>
                                </div>
                                <div class="booking-hours d-flex flex-wrap">
                                    @foreach (var horario in Model)
                                    {
                                        var tempoTrabalho = (horario.HorarioFechamento.Hour - horario.HorarioAbertura.Hour) * 60;
                                        DateTime horarioAtendimento = horario.HorarioAbertura;
                                        for (var i = 0; i < tempoTrabalho; i += 30)
                                        {
                                            <span id="horaDia" class="pegaHora" data-toggle="modal" data-target="#produtoModal" data-dia="@(data.AddDays(j + 1).ToShortDateString())">@(horarioAtendimento.ToShortTimeString())</span>
                                            horarioAtendimento = horario.HorarioAbertura.AddMinutes(30 + i);
                                        }
                                    }
                                </div>
                            </div>

                            <div class="single-date-hours">
                                <div class="booking-day">
                                    <h6>@(diasSemana[((int)data.AddDays(j + 2).DayOfWeek)]) </h6>
                                    <h6>@(data.AddDays(j + 2).ToShortDateString())</h6>
                                </div>
                                <div class="booking-hours d-flex flex-wrap">
                                    @foreach (var horario in Model)
                                    {
                                        var tempoTrabalho = (horario.HorarioFechamento.Hour - horario.HorarioAbertura.Hour) * 60;
                                        DateTime horarioAtendimento = horario.HorarioAbertura;
                                        for (var i = 0; i < tempoTrabalho; i += 30)
                                        {
                                            <span id="horaDia" class="pegaHora" data-toggle="modal" data-target="#produtoModal" data-dia="@(data.AddDays(j + 2).ToShortDateString())">@(horarioAtendimento.ToShortTimeString())</span>
                                            horarioAtendimento = horario.HorarioAbertura.AddMinutes(30 + i);
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Booking Area End -->
<!-- Modal -->
<div class="modal fade produtoModal" id="produtoModal" tabindex="-1" role="dialog" aria-labelledby="produtoModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content produtoModal">
            <div class="modal-header produtoModal">
                <h5 class="modal-title" id="produtoModalLabel">Produto</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body produtoModal">

                <label class="texto-label" for="HorarioAbertura">Horario:</label>
                <input id="horaSelecionada" type="time" class="form-control" required disabled />

                <label class="texto-label" for="HorarioFechamento">Data:</label>
                <input id="data" type="text" class="form-control" required disabled />

                <label class="texto-label" for="servico">Serviço:</label>
                <select id="servico" name="agenda.ServicoId" class="form-control">
                    @foreach (var servico in ViewBag.Servico)
                    {
                        <option value="@servico.Id" selected="@servico.Id.Equals(ViewBag.Agenda.ServicoId)">@servico.Tipo</option>
                    }
                </select>
                @if (Session["ClienteLogado"] != null)
                {
                    <label for="ClienteId">ClienteId:</label>
                    <label id="clienteId" type="number" class="form-control" required disabled> @((Session["ClienteLogado"] as Cliente).Id)</label>
                }


                <div class="input-group">
                    <div class="input-group-append" id="t">
                        <button class="btn btn-primary botao" type="button" onclick="AgendarHorario();" data-dismiss="modal">
                            <i class="fas fa-search fa-sm">Agendar</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var btn = document.querySelector('.btn2');
                btn.classList.add("active");

    var pegaValClick;
    $(".pegaHora").click(function () {
        var horaDia = $(this).text();
        $('#horaSelecionada').val(horaDia);

        var dataDia = $(this).data("dia");
        $('#data').val(dataDia);

        pegaValClick = $(this);
    });

    function AgendarHorario() {
        var horaSelecionada = $("#horaSelecionada").val();
        var data = $("#data").val();
        var servicoId = $('#servico').val();
        var clienteId = $("#clienteId").text();
        console.log(clienteId);

        $.ajax({
            type: 'POST',
            dataType: 'json',
            cache: false,
            url: "@Url.Action("AgendarHorario", "Agenda")", // webmethod or web serivces URL
            data: {
                HoraSelecionada: horaSelecionada,
                Data: data,
                ServicoId: servicoId,
                ClienteId: clienteId
            },
            complete:
            function validar(jqXHR, resposta) {
                if (jqXHR.responseJSON == true) {
                    alert("Sucesso ao agendar horario");
                } else {
                    pegaValClick.addClass("active");
                    pegaValClick.removeAttr("data-toggle");
                    alert("Horário Indisponível");
                }
            },
        }
        )
    };
</script>